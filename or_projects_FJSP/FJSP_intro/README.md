# 柔性作业车间调度问题的模型

## Reference

- 《柔性作业车间调度智能算法及其应用》高亮 张国辉 王晓娟 著


## 1 柔性作业车间调度问题描述
1. **柔性作业车间调度问题（FJSP）概述**
   - **定义**：$n$个工件在$m$台机器上加工，每个工件含一道或多道固定顺序工序，每道工序可在多台机器加工，加工时间因机器而异. 目标是为工序选最优机器，确定机器上工序加工顺序与时间，优化系统性能.   
   - **子问题**：包含机器选择（为工件选加工机器）和工序排序（确定机器上工序加工顺序）.   
   - **约束条件**：共6条，如同一机器同一时刻仅加工一个工件、同一工件工序同一时刻仅由一台机器加工、工序加工不中断、工件优先级相同、同工件工序有先后约束、零时刻所有工件均可加工.   

2. **FJSP分类**  
   - **完全柔性（T-FJSP）**：所有工件的每道工序均可在可选机器中任意选择加工.   

        - T-FJSP 实例  

            | 工件 | 工序  | $M_1$ | $M_2$ | $M_3$ | $M_4$ | $M_5$ |  
            |------|-------|---------|---------|---------|---------|---------|  
            | $J_1$ | $O_{11}$ | 2       | 6       | 5       | 3       | 4       |  
            | $J_1$ | $O_{12}$ | 6       | 8       | 2       | 4       | 5       |  
            | $J_2$ | $O_{21}$ | 3       | 3       | 6       | 7       | 5       |  
            | $J_2$ | $O_{22}$ | 4       | 6       | 5       | 9       | 6       |  
            | $J_2$ | $O_{23}$ | 3       | 7       | 11      | 5       | 8       |  

            注：$J_1$ 表示工件 1；$O_{11}$ 表示第 1 个工件的第 1 道工序；表中数据表示在该台机器上的加工时间.   


   - **部分柔性（P-FJSP）**：至少存在一道工序，只能选择部分机器加工（机器集的真子集）. P-FJSP更贴近实际生产，复杂度高于T-FJSP（T-FJSP是P-FJSP的特例）.  

        - P-FJSP 实例 
            | 工件 | 工序  | $M_1$ | $M_2$ | $M_3$ | $M_4$ | $M_5$ |  
            |------|-------|---------|---------|---------|---------|---------|  
            | $J_1$ | $O_{11}$ | 2       | 6       | 5       | 3       | 4       |  
            | $J_1$ | $O_{12}$ | —       | 8       | —       | 4       | —       |  
            | $J_2$ | $O_{21}$ | 3       | —       | 6       | —       | 5       |  
            | $J_2$ | $O_{22}$ | 4       | 6       | 5       | —       | —       |  
            | $J_2$ | $O_{23}$ | —       | 7       | 11      | 5       | 8       |  

            注：$J_1$ 表示工件 1；$O_{11}$ 表示第 1 个工件的第 1 道工序；表中数据表示在该台机器上的加工时间；“—”表示此工序不能选择上面对应的机器进行加工. 

3. **问题复杂度**  
   - FJSP具循环排列特性，与传统JSP不同（传统JSP每工序仅固定机器加工），解空间巨大（含$m^n×(n!)^m$种排列），属NP-hard问题，求解难度高.   
   



## 2 FJSP的数学模型  

### 符号定义  
- $ n $：工件总数.   
- $ m $：机器总数.   
- $ \Omega $：总的机器集.   
- $ i, e $：机器序号，$ i, e = 1,2,3,\cdots,m $.   
- $ j, k $：工件序号，$ j, k = 1,2,3,\cdots,n $.   
- $ h_j $：第 $ j $ 个工件的工序总数.   
- $ l $：工序序号，$ l = 1,2,3,\cdots,h_j $.   
- $ \Omega_{jh} $：第 $ j $ 个工件的第 $ h $ 道工序的可选加工机器集.   
- $ m_{jh} $：第 $ j $ 个工件的第 $ h $ 道工序的可选加工机器数.   
- $ O_{jh} $：第 $ j $ 个工件的第 $ h $ 道工序.   
- $ M_{jhi} $：第 $ j $ 个工件的第 $ h $ 道工序在机器 $ i $ 上加工.   
- $ p_{jhi} $：第 $ j $ 个工件的第 $ h $ 道工序在机器 $ i $ 上的加工时间.   
- $ s_{jh} $：第 $ j $ 个工件的第 $ h $ 道工序加工开始时间.   
- $ c_{jh} $：第 $ j $ 个工件的第 $ h $ 道工序加工完成时间.   
- $ L $：一个足够大的正数.   
- $ d_j $：第 $ j $ 个工件的交货期.   
- $ C_j $：每个工件的完成时间.   
- $ C_{\text{max}} $：最大完工时间.   
- $ T_a $：$ T_a = \sum_{j=1}^{n} h_j $，所有工件工序总数.   
- $ x_{jhi} = \begin{cases} 1, & \text{如果工序 } O_{jh} \text{ 选择机器 } i.  \\ 0, & \text{否则. } \end{cases} $  
- $ y_{jbkl} = \begin{cases} 1, & \text{如果 } O_{jb} \text{ 先于 } O_{kl} \text{ 加工. } \\ 0, & \text{否则. } \end{cases} $  
- 若 $ \Omega_{jh} = \Omega, \forall j \in [1,n], \forall h \in [1,h_j] $，则是 T-FJSP；  
- 若 $ \Omega_{jh} \subset \Omega, \exists j \in [1,n], \exists h \in [1,h_j] $，则是 P-FJSP.   

### 约束条件  
一般 FJSP 受下列约束：  
$$
s_{jh} + x_{jhi} \times p_{jhi} \leqslant c_{jh} \quad (2.1)
$$  
式中：$ i = 1,2,3,\cdots,m; j = 1,2,3,\cdots,n; h = 1,2,3,\cdots,h_j $.   

$$
c_{jh} \leqslant s_{j(h+1)} \quad (2.2)
$$  
式中：$ j = 1,2,\cdots,n; h = 1,2,3,\cdots,h_j - 1 $.   

$$
c_{jh_j} \leqslant C_{\text{max}} \quad (2.3)
$$  
式中：$ j = 1,2,3,\cdots,n $.   

$$
s_{jh} + p_{jhi} \leqslant s_{kl} + L(1 - y_{jbkl}) \quad (2.4)
$$  
式中：$ j = 0,1,2,\cdots,n; k = 1,2,3,\cdots,n; h = 1,2,3,\cdots,h_j; l = 1,2,3,\cdots,h_k; i = 1,2,3,\cdots,m $.   

$$
c_{jh} \leqslant s_{j(h+1)} + L(1 - y_{hhl(h+1)}) \quad (2.5)
$$  
式中：$ j = 1,2,3,\cdots,n; k = 0,1,2,\cdots,n; h = 1,2,3,\cdots,h_j - 1; l = 1,2,3,\cdots,h_k; i = 1,2,3,\cdots,m $.   

$$
\sum_{i=1}^{m_{jh}} x_{jhi} = 1 \quad (2.6)
$$  
式中：$ h = 1,2,3,\cdots,h_j; j = 1,2,3,\cdots,n $.   

$$
\sum_{j=1}^{n} \sum_{h=1}^{h_j} y_{jbkl} = x_{kli} \quad (2.7)
$$  
式中：$ i = 1,2,3,\cdots,m; k = 1,2,3,\cdots,n; l = 1,2,3,\cdots,h_k $.   

$$
\sum_{k=1}^{n} \sum_{l=1}^{h_k} y_{jbkl} = x_{jhi} \quad (2.8)
$$  
式中：$ i = 1,2,3,\cdots,m; j = 1,2,3,\cdots,n; h = 1,2,3,\cdots,h_k $.   

$$
s_{jh} \geqslant 0, c_{jh} \geqslant 0 \quad (2.9)
$$  
式中：$ j = 0,1,2,\cdots,n; h = 1,2,\cdots,h_j $.   

- **约束说明**：  
  - 式(2.1)和式(2.2)：工件工序先后顺序约束.   
  - 式(2.3)：工件完工时间不超总完工时间约束.   
  - 式(2.4)和式(2.5)：同一机器同一时刻仅加工一道工序约束.   
  - 式(2.6)：机器约束，同一时刻一道工序仅一台机器加工.   
  - 式(2.7)和式(2.8)：机器存在循环操作约束.   
  - 式(2.9)：参数为正数约束. 






## 3 FJSP评价指标  

在 FJSP 的求解过程中，调度方案优劣的评价需通过目标函数判断，目标函数即常用评价指标。FJSP 不仅包含经典 JSP 常用评价指标，还有其他评价指标。以下列出较常用的几个：  

1. 最大完工时间最小  
    完工时间是每个工件最后一道工序完成的时间，其中最大的那个时间就是最大完工时间（makespan）。它是衡量调度方案的根本指标，主要体现车间的生产效率，是 FJSP 研究中应用最广泛的评价指标之一，可表示为：  
    $$
    f_1 = \min(\max_{1 \leqslant j \leqslant n}(C_j)) \quad (3.1)
    $$  

2. 机器最大负荷最小  
    在 FJSP 求解中，存在选择机器的过程，各台机器的负荷随调度方案不同。负荷最大的机器是瓶颈设备。要提高机器利用率，需使各台机器负荷尽量小且平衡，可表示为：  
    $$
    f_2 = \min\left(\max_{1 \leqslant i \leqslant m}\sum_{j=1}^{n}\sum_{h=1}^{h_j}p_{jhi}x_{jhi}\right) \quad (3.2)
    $$  
3. 总机器负荷最小  
    工序在不同机器上加工时间不同，总的机器负荷随调度方案变化。在尽量使最大完工时间一样的情况下，减少所有机器的总消耗，可表示为：  
    $$
    f_3 = \min\left(\sum_{i=1}^{m}\sum_{j=1}^{n}\sum_{h=1}^{h_j}p_{jhi}x_{jhi}\right) \quad (3.3)
    $$  

4. 提前/拖期最小  
    准时制生产需考虑交货期问题，工件完工时间越接近交货期，交货期性能越好。  
    - 用最大提前时间指标 $ E_j $ 表示工件 $ j $ 的交货期 $ d_j $ 与其完成时间 $ C_j $ 的非负差值，即：  
    $$
    E_j = \max(d_j - C_j, 0)
    $$  
    - 用最大拖期时间指标 $ T_j $ 表示工件 $ j $ 的完成时间 $ C_j $ 与交货期时间 $ d_j $ 的非负差值，即：  
    $$
    T_j = \max(C_j - d_j, 0)
    $$  
    - 最大提前时间最小和最大拖期时间最小分别表示为：  
    $$
    f_4 = \min(\max_{1 \leqslant j \leqslant n}(E_j)) \quad (3.4)
    $$  
    $$
    f_5 = \min(\max_{1 \leqslant j \leqslant n}(T_j)) \quad (3.5)
    $$  

以上几种性能评价指标较为常用。还有如考虑工件安装时间的性能评价指标或更贴近生产成本的一些成本指标等。如果性能评价指标函数是完工时间的非减函数，则称为正规性能指标（regular measure），如 $ f_1、f_2、f_3、f_4、f_5 $；否则称为非正规性能指标，如 $ E/T $ 惩罚代价小等。
